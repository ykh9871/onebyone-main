#!/bin/sh
# 비디오 프로젝트 실행 및 관리를 위한 유틸리티 스크립트

COMMAND=$1
shift 1  # 첫 번째 인자만 제거하고 나머지는 그대로 유지

# Windows 환경 감지 (MINGW, MSYS, CYGWIN)
case "$(uname -s)" in
    MINGW*|MSYS*|CYGWIN*)
        # Windows에서는 색상 코드 비활성화
        GREEN=''
        YELLOW=''
        BLUE=''
        RED=''
        NC=''
        ;;
    *)
        # 다른 환경에서는 색상 코드 활성화
        GREEN='\033[0;32m'
        YELLOW='\033[1;33m'
        BLUE='\033[0;34m'
        RED='\033[0;31m'
        NC='\033[0m' # No Color
        ;;
esac

# 사용법 출력 함수
show_usage() {
    echo "${YELLOW}onebyone Project 관리 유틸리티${NC}"
    echo ""
    echo "사용법: ./run {명령어} [옵션]"
    echo ""
    echo "${GREEN}가능한 명령어:${NC}"
    echo "  ${BLUE}start${NC}         - 모든 서비스 시작"
    echo "  ${BLUE}stop${NC}          - 모든 서비스 중지"
    echo "  ${BLUE}restart${NC}       - 모든 서비스 재시작"
    echo "  ${BLUE}build${NC}         - 모든 서비스 빌드 후 시작"
    echo "  ${BLUE}logs${NC}          - 로그 출력 (옵션: 서비스명)"
    echo "  ${BLUE}migrate${NC}       - Django 마이그레이션 실행"
    echo "  ${BLUE}makemigrations${NC} - Django 마이그레이션 파일 생성"
    echo "  ${BLUE}showmigrations${NC} - Django 마이그레이션 상태 확인"
    echo "  ${BLUE}createsuperuser${NC} - Django 관리자 계정 생성"
    echo "  ${BLUE}shell${NC}         - Django 쉘 실행"
    echo "  ${BLUE}dbshell${NC}       - PostgreSQL 쉘 접속"
    echo "  ${BLUE}npminstall${NC}    - Frontend npm 패키지 설치"
    echo "  ${BLUE}frontend${NC}      - Frontend 서비스 명령 실행 (옵션: npm 명령어)"
    echo "  ${BLUE}backend${NC}       - Backend 서비스 명령 실행 (옵션: python 명령어)"
    echo "  ${BLUE}exec${NC}          - 컨테이너에 명령 실행 (옵션: 서비스명 명령어)"
    echo "  ${BLUE}clean${NC}         - 사용하지 않는 컨테이너, 이미지, 볼륨 제거"
    echo "  ${BLUE}reset${NC}         - 모든 데이터 초기화 (주의!)"
    echo ""
    echo "예시:"
    echo "  ./run start                    # 모든 서비스 시작"
    echo "  ./run logs backend             # 백엔드 로그 확인"
    echo "  ./run test_upload sample.mp4   # 비디오 업로드 테스트"
    echo "  ./run cleanup_expired          # 만료된 비디오 정리"
    echo "  ./run s3_test                  # S3 연결 테스트"
}

# 명령어가 없으면 사용법 표시
if [ -z "$COMMAND" ]; then
    show_usage
    exit 1
fi

case $COMMAND in
    # 시작, 중지, 빌드 명령어
    start)
        echo "${GREEN}서비스 시작 중...${NC}"
        docker-compose up -d
        echo "${YELLOW}서비스가 시작되었습니다!${NC}"
        echo "Frontend: http://localhost:3000"
        echo "Backend API: http://localhost:8000/api"
        echo "Django Admin: http://localhost:8000/admin"
        ;;
    stop)
        echo "${GREEN}서비스 중지 중...${NC}"
        docker-compose down
        ;;
    restart)
        echo "${GREEN}서비스 재시작 중...${NC}"
        docker-compose restart
        ;;
    build)
        echo "${GREEN}서비스 빌드 및 시작 중...${NC}"
        docker-compose up -d --build
        ;;
    
    # 로그 명령어
    logs)
        if [ $# -eq 0 ]; then
            docker-compose logs -f
        else
            echo "${GREEN}$1 서비스의 로그 출력 중...${NC}"
            docker-compose logs -f $1
        fi
        ;;
    
    # Django 관련 명령어
    migrate)
        echo "${GREEN}Django 마이그레이션 실행 중...${NC}"
        docker-compose exec backend python manage.py migrate
        ;;
    makemigrations)
        OPTION=$1
        echo "${GREEN}Django 마이그레이션 파일 생성 중...${NC}"
        docker-compose exec backend python manage.py makemigrations $OPTION
        ;;
    showmigrations)
        echo "${GREEN}Django 마이그레이션 상태 확인 중...${NC}"
        docker-compose exec backend python manage.py showmigrations
        ;;
    createsuperuser)
        echo "${GREEN}Django 관리자 계정 생성 중...${NC}"
        docker-compose exec backend python manage.py createsuperuser
        ;;
    shell)
        echo "${GREEN}Django 쉘 실행 중...${NC}"
        docker-compose exec backend python manage.py shell
        ;;
    dbshell)
        echo "${GREEN}PostgreSQL 쉘 접속 중...${NC}"
        docker-compose exec db psql -U yoongyuheon -d ondebyone
        ;;
    # Frontend 관련 명령어
    npminstall)
        echo "${GREEN}Frontend npm 패키지 설치 중...${NC}"
        docker-compose exec frontend npm install
        ;;
    frontend)
        if [ $# -eq 0 ]; then
            echo "${RED}npm 명령어를 지정해주세요.${NC}"
            echo "예: ./run frontend build"
            exit 1
        fi
        echo "${GREEN}Frontend에서 npm $1 실행 중...${NC}"
        docker-compose exec frontend npm $@
        ;;
    backend)
        if [ $# -eq 0 ]; then
            echo "${RED}Python 명령어를 지정해주세요.${NC}"
            echo "예: ./run backend python --version"
            exit 1
        fi
        echo "${GREEN}Backend에서 $1 실행 중...${NC}"
        docker-compose exec backend $@
        ;;
    
    # 기타 명령어
    exec)
        if [ $# -eq 0 ]; then
            echo "${RED}서비스명을 지정해주세요.${NC}"
            echo "예: ./run exec backend bash"
            exit 1
        fi
        SERVICE=$1
        shift 1
        if [ $# -eq 0 ]; then
            echo "${RED}실행할 명령어를 지정해주세요.${NC}"
            echo "예: ./run exec backend bash"
            exit 1
        fi
        echo "${GREEN}${SERVICE}에서 $@ 실행 중...${NC}"
        docker-compose exec $SERVICE $@
        ;;
    clean)
        echo "${GREEN}사용하지 않는 컨테이너 제거 중...${NC}"
        docker container prune -f
        echo "${GREEN}사용하지 않는 이미지 제거 중...${NC}"
        docker image prune -f
        echo "${GREEN}사용하지 않는 볼륨 제거 중...${NC}"
        docker volume prune -f
        echo "${GREEN}Docker 네트워크 정리 중...${NC}"
        docker network prune -f
        ;;
    reset)
        echo "${RED}⚠️  모든 데이터가 삭제됩니다! 계속하시겠습니까? (y/N)${NC}"
        read -r CONFIRM
        case $CONFIRM in
            [Yy]* )
                echo "${GREEN}모든 서비스 중지 중...${NC}"
                docker-compose down -v
                echo "${GREEN}볼륨 삭제 중...${NC}"
                docker volume rm $(docker volume ls -q | grep onebyone) 2>/dev/null || true
                echo "${GREEN}데이터베이스 폴더 삭제 중...${NC}"
                rm -rf ./db/*
                echo "${GREEN}초기화 완료! ./run build로 다시 시작하세요.${NC}"
                ;;
            * )
                echo "${YELLOW}취소되었습니다.${NC}"
                ;;
        esac
        ;;
    
    # 도움말
    help)
        show_usage
        ;;
    
    # 알 수 없는 명령어
    *)
        echo "${RED}알 수 없는 명령어: $COMMAND${NC}"
        show_usage
        exit 1
        ;;
esac

exit 0